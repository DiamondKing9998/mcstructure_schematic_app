<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCStructure Analyzer &amp; 3D Visualizer</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load OrbitControls for camera interaction -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Custom styles for better aesthetics and layout */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 300px; /* 3D view | Sidebar */
            height: calc(100vh - 80px); /* Account for header/padding */
        }
        #canvas-container {
            position: relative;
            background: linear-gradient(135deg, #1f2937, #374151); /* Dark background for 3D */
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        #material-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            scrollbar-width: thin;
        }
        /* Custom Scrollbar for dark theme */
        #material-list::-webkit-scrollbar { width: 8px; }
        #material-list::-webkit-scrollbar-thumb { background-color: #6b7280; border-radius: 4px; }
        #material-list::-webkit-scrollbar-track { background-color: #1f2937; }

        /* The canvas itself will be appended here */
        canvas { display: block; }
    </style>
</head>
<body class="p-4">

    <!-- Custom Message Box for Errors and Successes (Replaces alert()) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full text-center">
            <h3 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">Error</h3>
            <p id="messageText" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('messageBox').classList.add('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                Acknowledge
            </button>
        </div>
    </div>

    <header class="mb-4 flex justify-between items-center bg-white p-4 rounded-xl shadow-lg">
        <h1 class="text-3xl font-extrabold text-gray-800">Minecraft Structure Analyzer</h1>
        <input type="file" id="fileInput" accept=".mcstructure" class="hidden" onchange="handleFileSelect(event)">
        <label for="fileInput" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 shadow-md hover:shadow-lg transform hover:scale-105">
            Load .mcstructure File
        </label>
    </header>

    <main id="app-container" class="grid-container gap-4">
        <!-- 3D Visualizer Container -->
        <div id="canvas-container" class="p-2">
            <div id="loadingMessage" class="absolute inset-0 flex items-center justify-center text-white text-xl bg-gray-900 bg-opacity-80 transition duration-500 z-10 hidden">
                Parsing structure and calculating materials...
            </div>
            <div id="emptyState" class="absolute inset-0 flex items-center justify-center text-white text-xl bg-gray-800 transition duration-500 z-10">
                Upload a .mcstructure file to begin visualization.
            </div>
        </div>

        <!-- Sidebar for Controls and Material List -->
        <aside class="bg-white p-5 rounded-xl shadow-lg flex flex-col">
            <h2 class="text-xl font-bold mb-3 text-gray-700">Structure Details</h2>

            <!-- Layer Filter Controls -->
            <div id="layerControls" class="mb-5 p-3 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <h3 class="font-semibold text-lg mb-2 text-gray-700">Layer Filter (Y-Axis)</h3>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">Current Layer: <span id="currentLayerDisplay">All</span></span>
                    <button id="toggleGrid" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full transition">
                        Show Grid
                    </button>
                </div>
                <input type="range" id="layerSlider" min="0" max="10" value="0" step="1" class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg">
            </div>

            <!-- Material List -->
            <h3 class="font-semibold text-lg mb-3 text-gray-700 border-t pt-3 mt-auto">Material List (64/Stack)</h3>
            <div id="material-list" class="flex-grow p-2 bg-gray-50 rounded-lg">
                <p id="materialEmpty" class="text-sm text-gray-500">Materials will appear here after loading.</p>
            </div>
        </aside>
    </main>

    <script type="module">
        // Import the parsing function from the dedicated module
        import { parseMCStructureBinary, MOCK_BLOCK_DATA } from './nbt_parser.js';
        
        // --- CONSTANTS AND GLOBALS ---
        const BLOCK_SIZE = 1; 
        const STACK_SIZE = 64;

        // Three.js Globals
        let scene, camera, renderer, controls, blockGroup, gridHelper;
        let structureData = null;
        let maxLayer = 0;
        let currentLayer = 0;
        let isGridVisible = true;

        // --- CUSTOM UI FUNCTIONS (showMessage is unchanged) ---
        function showMessage(title, text, isError = true) {
            const box = document.getElementById('messageBox');
            const titleEl = document.getElementById('messageTitle');
            const textEl = document.getElementById('messageText');
            const buttonEl = box.querySelector('button');

            titleEl.textContent = title;
            textEl.innerHTML = text; 

            titleEl.classList.toggle('text-red-600', isError);
            titleEl.classList.toggle('text-indigo-600', !isError);
            buttonEl.classList.toggle('bg-red-500', isError);
            buttonEl.classList.toggle('hover:bg-red-600', isError);
            buttonEl.classList.toggle('bg-indigo-600', !isError);
            buttonEl.classList.toggle('hover:bg-indigo-700', !isError);
            
            box.classList.remove('hidden');
        }

        // --- CORE APPLICATION FUNCTIONS ---

        /**
         * Calculates material counts, rounds them up to stacks, and displays the list.
         * @param {object} materials - A map of block ID to count.
         */
        function displayMaterialList(materials) {
            console.log("Building Material List.");
            const listContainer = document.getElementById('material-list');
            listContainer.innerHTML = '';
            document.getElementById('materialEmpty').classList.add('hidden');

            const sortedMaterials = Object.entries(materials).sort(([, a], [, b]) => b - a);

            if (sortedMaterials.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500">No solid blocks found in the structure data.</p>';
                console.warn("Material list is empty.");
                return;
            }

            sortedMaterials.forEach(([id, count]) => {
                const totalStacks = Math.ceil(count / STACK_SIZE);
                const stacksDisplay = `${totalStacks} stack${totalStacks !== 1 ? 's' : ''}`;
                const baseId = id.split(':')[1] || id; 

                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center p-2 mb-1 bg-white rounded-md shadow-sm border-l-4 border-indigo-400';
                listItem.innerHTML = `
                    <span class="font-medium text-gray-800">${baseId.replace(/_/g, ' ').toUpperCase()}</span>
                    <div class="text-right">
                        <span class="block text-sm font-bold text-indigo-600">${stacksDisplay}</span>
                        <span class="block text-xs text-gray-500">${count} total (Mocked)</span>
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
            console.log(`Material list built with ${sortedMaterials.length} unique items.`);
        }

        /**
         * Initializes the Three.js scene, camera, and controls.
         */
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene setup... (unchanged)
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(20, 20, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 100;

            scene.add(new THREE.AmbientLight(0x404040)); 
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);

            blockGroup = new THREE.Group();
            scene.add(blockGroup);

            gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x444444);
            gridHelper.position.y = -BLOCK_SIZE / 2; 
            scene.add(gridHelper);

            window.addEventListener('resize', onWindowResize, false);
            console.log("Three.js environment initialized.");
        }

        /**
         * Resizes the Three.js renderer and camera.
         */
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        /**
         * The main render loop.
         */
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }

        /**
         * Draws all blocks from the structure data in 3D.
         * @param {object} data - The parsed structure data.
         */
        function buildStructure(data) {
            console.log("Building 3D structure visualization.");
            while (blockGroup.children.length > 0) {
                blockGroup.remove(blockGroup.children[0]);
            }

            const { blocks, size } = data;
            const center = { x: (size.x - 1) * BLOCK_SIZE / 2, y: 0, z: (size.z - 1) * BLOCK_SIZE / 2 };

            const geometry = new THREE.BoxGeometry(BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);

            blocks.forEach(block => {
                const material = new THREE.MeshLambertMaterial({ color: block.color });
                const mesh = new THREE.Mesh(geometry, material);

                mesh.position.set(
                    block.x * BLOCK_SIZE - center.x,
                    block.y * BLOCK_SIZE + BLOCK_SIZE / 2,
                    block.z * BLOCK_SIZE - center.z
                );
                mesh.userData = { layer: block.layer };

                blockGroup.add(mesh);
            });

            // Adjust grid size
            scene.remove(gridHelper);
            const gridRange = Math.max(size.x, size.z) * BLOCK_SIZE;
            gridHelper = new THREE.GridHelper(gridRange, gridRange, 0x444444, 0x444444);
            gridHelper.position.y = -BLOCK_SIZE / 2;
            gridHelper.visible = isGridVisible;
            scene.add(gridHelper);

            // Recenter camera view
            controls.target.set(0, size.y * BLOCK_SIZE / 2, 0);
            controls.update();
            console.log(`3D structure built. Dimensions: ${size.x}x${size.y}x${size.z}`);
        }

        /**
         * Filters the 3D visualization to show only blocks up to the selected layer.
         * @param {number} layer - The maximum layer index to display.
         */
        function filterByLayer(layer) {
            currentLayer = layer;
            document.getElementById('currentLayerDisplay').textContent = layer === maxLayer ? 'All' : layer;
            console.log(`Layer filter set to: ${layer}`);

            if (!blockGroup) return;

            blockGroup.children.forEach(mesh => {
                const blockLayer = mesh.userData.layer;
                mesh.visible = blockLayer <= currentLayer;
            });
        }

        // --- EVENT HANDLERS ---

        /**
         * Main entry point for file processing.
         * Calls the external parseMCStructureBinary function.
         */
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log(`Starting file processing for: ${file.name} (${file.size} bytes)`);

            document.getElementById('fileInput').value = '';
            document.getElementById('loadingMessage').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                console.log("FileReader completed reading file into ArrayBuffer.");
                try {
                    const buffer = e.target.result;
                    
                    // Call the dedicated parsing module
                    await parseMCStructureBinary(buffer);

                    // Since true parsing is complex, we stick to mock data for visualization
                    structureData = MOCK_BLOCK_DATA;
                    maxLayer = structureData.size.y - 1;
                    currentLayer = maxLayer;


                    displayMaterialList(structureData.materials);

                    const slider = document.getElementById('layerSlider');
                    slider.min = 0;
                    slider.max = maxLayer;
                    slider.value = maxLayer; 
                    document.getElementById('currentLayerDisplay').textContent = 'All';

                    buildStructure(structureData);
                    
                    document.getElementById('loadingMessage').classList.add('hidden');
                    showMessage("Parsing Attempt Complete", 
                        `The Gzip decompression and NBT header read succeeded for **${file.name}**!
                        <p class="text-left mt-3">The complex NBT block data parsing (Step 3) is still mocked due to library complexity. The app is displaying placeholder data, but your file passed the binary integrity check.</p>`, 
                        false);

                } catch (error) {
                    document.getElementById('loadingMessage').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');

                    console.error("Critical File Processing Error:", error);
                    const errorMessage = `The file **${file.name}** failed to load.
                    
                    <p class="text-left mt-3">**Reason:** ${error.message}</p>
                    <p class="text-left mt-3">Please check the console logs for detailed step failures (Gzip or NBT Header Check).</p>
                    `;
                    showMessage("Structure File Error", errorMessage, true);
                }
            };
            
            reader.onerror = (e) => {
                console.error("FileReader Error:", e);
                document.getElementById('loadingMessage').classList.add('hidden');
                showMessage("File Read Error", "The browser could not read the file. This might be due to file permissions or corruption.", true);
            };

            reader.readAsArrayBuffer(file);
        }

        // --- INITIALIZATION ---
        window.onload = function () {
            console.log("Application started. Initializing Three.js.");
            initThreeJS();
            animate();

            const slider = document.getElementById('layerSlider');
            slider.addEventListener('input', (e) => {
                const layer = parseInt(e.target.value, 10);
                filterByLayer(layer);
            });

            const toggleGridButton = document.getElementById('toggleGrid');
            toggleGridButton.addEventListener('click', () => {
                isGridVisible = !isGridVisible;
                gridHelper.visible = isGridVisible;
                toggleGridButton.textContent = isGridVisible ? 'Hide Grid' : 'Show Grid';
                console.log(`Grid visibility toggled to: ${isGridVisible}`);
            });
        };
    </script>
</body>
</html>